package me.mehboss.recipe;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.inventory.InventoryType;
import org.bukkit.event.inventory.PrepareItemCraftEvent;
import org.bukkit.inventory.CraftingInventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.ShapedRecipe;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.plugin.Plugin;
import org.bukkit.plugin.java.JavaPlugin;

public class Main extends JavaPlugin implements Listener {

	ItemStack i = null;
	ShapedRecipe R = null;

	public HashMap<String, String> matches = new HashMap<String, String>();
	public HashMap<Integer, String> displayname = new HashMap<Integer, String>();
	public ArrayList<ShapedRecipe> recipe = new ArrayList<ShapedRecipe>();

	public void onEnable() {
		Plugin config = Bukkit.getPluginManager().getPlugin("CustomRecipes");

		config.saveDefaultConfig();

		Bukkit.getPluginManager().registerEvents(this, this);
		Bukkit.getServer().clearRecipes();
		Bukkit.resetRecipes();

		addItems();
	}

	@SuppressWarnings("deprecation")
	public void addItems() {

		Plugin config = Bukkit.getPluginManager().getPlugin("CustomRecipes");

		for (String item : config.getConfig().getConfigurationSection("Items").getKeys(false)) {
			int type = config.getConfig().getInt("Items." + item + ".Item");
			int amount = config.getConfig().getInt("Items." + item + ".Amount");

			i = new ItemStack(Material.getMaterial(type), amount);
			ItemMeta m = i.getItemMeta();

			m.setDisplayName(ChatColor.translateAlternateColorCodes('&',
					config.getConfig().getString("Items." + item + ".Name")));

			List<String> loreList = new ArrayList<String>();

			if (config.getConfig().getStringList("Items." + item + ".Lore") != null) {

				for (String Item1Lore : config.getConfig().getStringList("Items." + item + ".Lore")) {

					String crateLore = (Item1Lore.replaceAll("(&([a-fk-o0-9]))", "\u00A7$2"));

					loreList.add(crateLore);
				}
				m.setLore(loreList);
			}

			i.setItemMeta(m);

			if (config.getConfig().getStringList("Items." + item + ".Enchantments") != null) {

				for (String e : config.getConfig().getStringList("Items." + item + ".Enchantments")) {
					String[] breakdown = e.split(":");

					String enchantment = breakdown[0];

					int lvl = Integer.parseInt(breakdown[1]);

					i.addUnsafeEnchantment(Enchantment.getByName(enchantment), lvl);
				}
			}

			i.setItemMeta(m);

			List<String> r = config.getConfig().getStringList("Items." + item + ".ItemCrafting");

			String line1 = r.get(0);
			String line2 = r.get(1);
			String line3 = r.get(2);

			R = new ShapedRecipe(i);

			R.shape(line1, line2, line3);

			for (String I : config.getConfig().getStringList("Items." + item + ".Ingredients")) {
				String[] b = I.split(":");

				char lin1 = b[0].charAt(0);

				String lin2 = b[1];

				Material mi = Material.matchMaterial(lin2);

				R.setIngredient(lin1, mi);
			}
			Bukkit.getServer().addRecipe(R);
			recipe.add(R);
		}
	}

	ItemStack Item = null;

	@EventHandler
	public void check(PrepareItemCraftEvent e) {

		CraftingInventory inv = e.getInventory();

		Boolean rrec = false;

		Plugin config = Bukkit.getPluginManager().getPlugin("CustomRecipes");

		if (inv.getType() == InventoryType.WORKBENCH) {

			for (ShapedRecipe newrecipe : recipe) {
				if (inv.getResult().equals(newrecipe.getResult())) {

					Item = newrecipe.getResult();
					rrec = true;

					inv.setResult(new ItemStack(Material.AIR));
					break;
				}
			}
			if (rrec == true) {

				Bukkit.broadcastMessage("yes");

				boolean itemmatches = true;

				if (Item.hasItemMeta() && Item.getItemMeta().hasDisplayName()) {

					Bukkit.broadcastMessage("yee");

					for (String name : config.getConfig().getConfigurationSection("Items").getKeys(false)) {

						String I = config.getConfig().getString("Items." + name + ".Name");

						Bukkit.broadcastMessage("yep");
						if (ChatColor.translateAlternateColorCodes('&', I)
								.equals(Item.getItemMeta().getDisplayName())) {

							for (String In : config.getConfig().getStringList("Items." + name + ".Ingredients")) {

								String[] newsplit = In.split(":");

								System.out.println(newsplit);

								if (newsplit.length == 2) {
									matches.put(newsplit[0], "false");
									System.out.println("one");
								} else if (newsplit.length == 3) {
									matches.put(newsplit[0], newsplit[2]);
								}
							}

							System.out.print("---------------------------");
							for (String matchess : matches.values()) {
								System.out.print(matchess);
							}
							System.out.print("---------------------------");

							List<String> r = config.getConfig().getStringList("Items." + name + ".ItemCrafting");

							String row1 = r.get(0);
							String row2 = r.get(1);
							String row3 = r.get(2);

							// loops 3 times for all crafting rows

							String letter = null;

							for (int j = 0; j < 9; j++) {

								String[] newsplit1 = row1.split("");
								String[] newsplit2 = row2.split("");
								String[] newsplit3 = row3.split("");

								if (j == 0) {
									String slot1 = newsplit1[0];
									letter = matches.get(slot1); // slot 1

								} else if (j == 1) {

									String slot2 = newsplit1[1];
									letter = matches.get(slot2); // slot 1

								} else if (j == 2) {

									String slot3 = newsplit1[2];
									letter = matches.get(slot3); // slot 1

								} else if (j == 3) {

									String slot4 = newsplit2[0];
									letter = matches.get(slot4); // slot 1

								} else if (j == 4) {

									String slot5 = newsplit2[1];
									letter = matches.get(slot5); // slot 1

								} else if (j == 5) {

									String slot6 = newsplit2[2];
									letter = matches.get(slot6); // slot 1

								} else if (j == 6) {

									String slot7 = newsplit3[0];
									letter = matches.get(slot7); // slot 1

								} else if (j == 7) {

									String slot8 = newsplit3[1];
									letter = matches.get(slot8); // slot 1

								} else if (j == 8) {

									String slot9 = newsplit3[2];
									letter = matches.get(slot9); // slot 1

								}

								if (letter != null) {
									displayname.put(j, letter);
								} else {
									displayname.put(j, "false");
								}
							}

							Bukkit.broadcastMessage("bob");

							for (String displaynamee : displayname.values()) {
								System.out.print(displaynamee);
							}

							for (int j = 0; j < 9; j++) {

								if (inv.getItem(j) != null && inv.getItem(j).getType() != null) {
									Bukkit.broadcastMessage("true1");

									if (!(displayname.get(j).equals("false"))) {
										Bukkit.broadcastMessage("true2");
										if (inv.getItem(j).hasItemMeta()
												&& inv.getItem(j).getItemMeta().hasDisplayName()) {
											Bukkit.broadcastMessage("true3");

											if (!(inv.getItem(j).getItemMeta().getDisplayName().equals(
													ChatColor.translateAlternateColorCodes('&', displayname.get(j))))) {
												Bukkit.broadcastMessage("true4");
												System.out.println(j);
												System.out.println(displayname.get(1));
												System.out.println(displayname.get(2));
												itemmatches = false;
											}
										}
									}
								}
							}

							displayname.clear();
							matches.clear();

							if (itemmatches == true) {
								inv.setResult(new ItemStack(Item));

							} else {
								inv.setResult(new ItemStack(Material.AIR));
							}

							Item = null;
						}
					}
				}
			}
		}
	}
}
